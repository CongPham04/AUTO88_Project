version: '3.8'

services:
  # ------------------------------------
  # 1. Database Service (MySQL)
  # ------------------------------------
  db:
    image: mysql:8.0
    container_name: auto88_mysql
    environment:
      MYSQL_DATABASE: car_sales_db 
      MYSQL_ROOT_PASSWORD: Auto88SecurePwd # <-- Máº­t kháº©u chÃ­nh thá»©c
      # ÄÃ£ bá» MYSQL_USER/MYSQL_PASSWORD
    ports:
      - "3306:3306"
    volumes:
    # Ãnh xáº¡ khá»Ÿi táº¡o database
      - ./init-db:/docker-entrypoint-initdb.d
      - db_data:/var/lib/mysql
    hostname: db
    
    healthcheck: # <-- THÃŠM HEALTHCHECK: Äáº£m báº£o DB sáºµn sÃ ng
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
      interval: 5s
    restart: always

  # ------------------------------------
  # 2. Backend Service (Spring Boot/Java 17)
  # ------------------------------------
  backend:
    build:
      context: ./oto-shop 
      dockerfile: Dockerfile.be
    image: auto88-be:latest
    container_name: auto88_be
    ports:
      - "8080:8080"
    environment:
      # ðŸ”‘ CHUá»–I JDBC ÄÃƒ Sá»¬A: Kháº¯c phá»¥c lá»—i Public Key Retrieval
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/car_sales_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Auto88SecurePwd # <-- Pháº£i khá»›p vá»›i máº­t kháº©u DB
      
      # Cáº¤U HÃŒNH KHÃC
      JWT_SECRET: HCUzp+KbjzGwPpBYKLChUvu9WUc+D9b3kAvq1cDi45jkVKzf+EF9bpIeq42e0KFSm7Lqm2i93YLmi4qQ9lW5g== 
      CORS_ALLOWED_ORIGINS: http://localhost:3000
      SERVER_SERVLET_CONTEXT_PATH: /carshop

    # ðŸŽ¯ Ãnh xáº¡ thÆ° má»¥c Uploads cho Backend
    volumes:
      # [Host Path]:[Container Path]
      - ./oto-shop/uploads:/app/uploads
    # depends_on Ä‘Æ°á»£c cáº­p nháº­t Ä‘á»ƒ chá» healthcheck thÃ nh cÃ´ng
    depends_on:
      db:
        condition: service_healthy
    restart: always

  # ------------------------------------
  # 3. Frontend Service (React/Nginx)
  # ------------------------------------
  frontend:
    build:
      context: ./Auto88_Fontend 
      dockerfile: Dockerfile
    image: auto88-fe:latest
    container_name: auto88_fe
    ports:
      - "3000:80"
    depends_on:
      - backend
    restart: always

volumes:
  db_data:
  # cháº¡y lá»‡nh
  # docker-compose up -d --build Ä‘á»ƒ khá»Ÿi Ä‘á»™ng láº¡i toÃ n bá»™ dá»‹ch vá»¥ vá»›i cÃ¡c thay Ä‘á»•i má»›i nháº¥t
  # docker-compose down Ä‘á»ƒ dá»«ng vÃ  xÃ³a cÃ¡c container, máº¡ng vÃ  volume Ä‘Æ°á»£c táº¡o bá»Ÿi docker-compose up
  # docker-compose ps Ä‘á»ƒ kiá»ƒm tra tráº¡ng thÃ¡i cÃ¡c dá»‹ch vá»¥
  # docker-compose logs [service_name] Ä‘á»ƒ xem log cá»§a má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose logs -f [service_name] Ä‘á»ƒ theo dÃµi log thá»i gian thá»±c cá»§a má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose restart [service_name] Ä‘á»ƒ khá»Ÿi Ä‘á»™ng láº¡i má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose exec [service_name] /bin/bash Ä‘á»ƒ truy cáº­p vÃ o shell cá»§a má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose down -v Ä‘á»ƒ dá»«ng vÃ  xÃ³a cÃ¡c container, máº¡ng vÃ  volume Ä‘Æ°á»£c táº¡o bá»Ÿi docker-compose up
  # docker-compose build Ä‘á»ƒ xÃ¢y dá»±ng hoáº·c tÃ¡i xÃ¢y dá»±ng cÃ¡c dá»‹ch vá»¥
  # docker-compose pull Ä‘á»ƒ kÃ©o cÃ¡c hÃ¬nh áº£nh má»›i nháº¥t cho cÃ¡c dá»‹ch vá»¥ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong tá»‡p docker-compose.yml
  # docker-compose rm Ä‘á»ƒ xÃ³a cÃ¡c container Ä‘Ã£ dá»«ng
  # docker-compose config Ä‘á»ƒ kiá»ƒm tra vÃ  hiá»ƒn thá»‹ cáº¥u hÃ¬nh há»£p lá»‡ Ä‘Æ°á»£c táº¡o tá»« tá»‡p docker-compose.yml
  # docker-compose top Ä‘á»ƒ hiá»ƒn thá»‹ cÃ¡c quy trÃ¬nh Ä‘ang cháº¡y bÃªn trong cÃ¡c container cá»§a dá»‹ch vá»¥
  # docker-compose scale [service_name]=[number] Ä‘á»ƒ thay Ä‘á»•i sá»‘ lÆ°á»£ng container cháº¡y cho má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose version Ä‘á»ƒ kiá»ƒm tra phiÃªn báº£n cá»§a Docker Compose Ä‘Æ°á»£c cÃ i Ä‘áº·t trÃªn há»‡ thá»‘ng
  # docker-compose help Ä‘á»ƒ hiá»ƒn thá»‹ hÆ°á»›ng dáº«n sá»­ dá»¥ng vÃ  cÃ¡c lá»‡nh cÃ³ sáºµn trong Docker Compose
  # docker-compose logs --tail=100 [service_name] Ä‘á»ƒ xem 100 dÃ²ng log cuá»‘i cÃ¹ng cá»§a má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose pause [service_name] Ä‘á»ƒ táº¡m dá»«ng má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose unpause [service_name] Ä‘á»ƒ tiáº¿p tá»¥c má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ Ä‘Ã£ bá»‹ táº¡m dá»«ng
  # docker-compose top [service_name] Ä‘á»ƒ hiá»ƒn thá»‹ cÃ¡c quy trÃ¬nh Ä‘ang cháº¡y bÃªn trong cÃ¡c container cá»§a má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose exec [service_name] env Ä‘á»ƒ xem cÃ¡c biáº¿n mÃ´i trÆ°á»ng bÃªn trong má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose logs --follow [service_name] Ä‘á»ƒ theo dÃµi log thá»i gian thá»±c cá»§a má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose run [service_name] [command] Ä‘á»ƒ cháº¡y má»™t lá»‡nh táº¡m thá»i trong má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ
  # docker-compose config --services Ä‘á»ƒ liá»‡t kÃª táº¥t cáº£ cÃ¡c dá»‹ch vá»¥ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong tá»‡p docker-compose.yml
  # docker-compose config --volumes Ä‘á»ƒ liá»‡t kÃª táº¥t cáº£ cÃ¡c volume Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong tá»‡p docker-compose.yml
  # docker-compose config --networks Ä‘á»ƒ liá»‡t kÃª táº¥t cáº£ cÃ¡c máº¡ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong tá»‡p docker-compose.yml
  # docker-compose logs --since="2024-01-01T00:00:00" [service_name] Ä‘á»ƒ xem log cá»§a má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ ká»ƒ tá»« má»™t thá»i Ä‘iá»ƒm nháº¥t Ä‘á»‹nh
  # docker-compose logs --until="2024-01-02T00:00:00" [service_name] Ä‘á»ƒ xem log cá»§a má»™t dá»‹ch vá»¥ cá»¥ thá»ƒ cho Ä‘áº¿n má»™t thá»i Ä‘iá»ƒm nháº¥t Ä‘á»‹nh
  # docker-compose build --no-cache Ä‘á»ƒ xÃ¢y dá»±ng láº¡i cÃ¡c dá»‹ch vá»¥ mÃ  khÃ´ng sá»­ dá»¥ng bá»™ nhá»› Ä‘á»‡m
  # docker-compose up -d --force-recreate Ä‘á»ƒ tÃ¡i táº¡o láº¡i cÃ¡c container ngay cáº£ khi khÃ´ng cÃ³ thay Ä‘á»•i nÃ o trong cáº¥u hÃ¬nh
  # docker-compose down --rmi all Ä‘á»ƒ dá»«ng vÃ  xÃ³a cÃ¡c container, máº¡ng vÃ  xÃ³a táº¥t cáº£ cÃ¡c hÃ¬nh áº£nh Ä‘Æ°á»£c táº¡o bá»Ÿi docker-compose up
  # docker-compose down --volumes Ä‘á»ƒ dá»«ng vÃ  xÃ³a cÃ¡c container, máº¡ng vÃ  volume Ä‘Æ°á»£c táº¡o bá»Ÿi docker-compose up
  # docker compose up --build --force-recreate -d Ä‘á»ƒ xÃ¢y dá»±ng láº¡i vÃ  tÃ¡i táº¡o cÃ¡c container trong cháº¿ Ä‘á»™ ná»n